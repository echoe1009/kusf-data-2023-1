<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>잠실의 주인은 누구조</title>
    <link href="./logo.png" rel="shortcut icon" type="image/x-icon">

    <link rel="stylesheet" href="/css/bootstrap.css">
    <!--  부트스트랩 js 사용 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.js"></script>
    <!-- 합쳐지고 최소화된 최신 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

    <!-- 제이쿼리 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

    <link href="style.css" rel="stylesheet" type="text/css" />

    <!-- 캘린더 라이브러리 -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
    </style>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

    <script> 
    /*
        $(function() {
            getRoundPeriod();
            getRound();
        });*/

        // R1 ~ R33 선택창 불러오기
        function getRound() {
            $.ajax ({
                url   : "https://kusf-api-4.run.goorm.site/Round",     
                type : "GET",                           
                data : "",                    
                success : function(data, status, xhr) {     
                    console.log(data);

                    var roundList = data.roundList;
                    $("#RoundSb").empty(); // 라운드 선택 창 초기화

                    // 라운드 순서 정렬
                    function compareString(a, b) {
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });}
                    roundList.sort(compareString);

                    for (var i = 0; i < roundList.length; i++) {
                        console.log(roundList[i]);
                        var optionTag = "<option value='" + roundList[i] + "'>" + roundList[i] + "</option>";
                        $("#RoundSb").append(optionTag);
                    } 

                    $("#RoundSb").val(Round);
                },
                error   : function(xhr, status, error) {    
                    console.log(xhr);       
                    alert("실패!");               
                },
            });
        };


        var roundData = null;

        function getRoundPeriod() { // 라운드별 기간 출력
            $.ajax ({
                url   : "https://kusf-api-4.run.goorm.site/RoundPeriod",       
                type   : "GET",
                success : function(data, status, xhr) {
                    var round_list = data.Round_row;
                    var start_date_list = data.Start_Date;
                    var end_date_list = data.End_Date;

                    var roundArr = [];

                    for(let i = 0; i < round_list.length; i++) {
                        var endDateArr = end_date_list[i].split("-")
                        var num = String(Number(endDateArr[2]) + 1).padStart(2, "0")
                        var temp = endDateArr[0] + "-" + endDateArr[1] + "-" + num

                        var data = {
                            title: round_list[i],
                            start: start_date_list[i],
                            end: temp,
                            borderColor: '#19a585', // 이벤트의 테두리 색상 지정
                            textColor: '#ffffff', 
                            backgroundColor: '#19a585',
                        }
                        roundArr.push(data);
                    }

                    const calendarEl = document.getElementById('calendar')
                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        events: roundArr
                    })
                    calendar.render()

                    $("#periodTable").empty(); // 테이블 초기화
                    var columnTag = "<tr>";
                    columnTag += "<td>라운드</td>";
                    columnTag += "<td>기간</td>";
                    columnTag += "</tr>";

                    $("#periodTable").append(columnTag);


                    for(var i=0; i < round_list.length; i++) {
                        // 날짜 '-' 기준 분리 후 다시 '-'로 붙이기
                        var startDateParts = start_date_list[i].split("-");
                        var formattedStartDate = startDateParts[0] + "-" + startDateParts[1] + "-" + startDateParts[2];
                        var endDateParts = end_date_list[i].split("-");
                        var formattedEndDate = endDateParts[0] + "-" + endDateParts[1] + "-" + endDateParts[2];

                        var period = formattedStartDate + " ~ " + formattedEndDate
                        
                        var periodRowHtml = "<tr>";
                        periodRowHtml += "<td>" + round_list[i] + "</td>";
                        periodRowHtml += "<td>" + period + "</td>";
                        periodRowHtml += "</tr>";
                        console.log(periodRowHtml);
                        $("#periodTable").append(periodRowHtml);
                    }
                    // 첫행 (라운드, 기간) 삭제 -> body에서 따로 추가 (스크롤 문제)
                    $("#periodTable tr:first").remove(); 
                },
                error   : function(xhr, status, error) {    
                    console.log(xhr);                      
                },
            });
        };                          


        var list;
        var Round;
        function getRoundInfo(Round) { // 선택된 라운드 일정 출력
            $.ajax ({
                url   : "https://kusf-api-4.run.goorm.site/Info/"+ Round,       
                type   : "GET",
                success : function(data, status, xhr) {   
                    list = data.Round_number;
                    console.log(list);

                    $("#infoTable").empty(); // 테이블 삭제
                    var columnTag = "<tr>";
                    columnTag += "<td></td>";
                    columnTag += "<td>날짜</td>";
                    columnTag += "<td>홈</td>";
                    columnTag += "<td></td>";
                    columnTag += "<td>어웨이</td>";
                    columnTag += "<td>시작시간</td>";
                    columnTag += "</tr>";

                    $("#infoTable").append(columnTag);

                
                    for(var i=0; i < list.length; i++) {
                            var dateParts = list[i].Game_Date.split("-"); 
                            var formattedDate = dateParts[0] + "-" + dateParts[1] + "-" + dateParts[2]; // 날짜 형식 변환
                            var rowHtml = "<tr>";
                            var j = i + 1;
                            var vote_id = 'vote' + j;

                            rowHtml += '<td><input type="radio" name="vote" value="' + j + '" id="' + vote_id + '"></td>';
                            rowHtml += "<td>" + formattedDate + "</td>";
                            rowHtml += "<td><img src=./" + list[i].Home_Team_Logo + ".png width=20 height=20> " + list[i].Home_Team + "</td>";
                            rowHtml += "<td>" + "vs" + "</td>";
                            rowHtml += "<td>" + list[i].Away_Team + " <img src=./" + list[i].Away_Team_Logo + ".png width=20 height=20></td>";
                            rowHtml += "<td>" + list[i].Start_Time + "</td>";
                            rowHtml += "</tr>";
                            console.log(rowHtml);

                            $("#infoTable").append(rowHtml);
                        }
                },
                error   : function(xhr, status, error) {    
                    console.log(xhr);                      
                },
            });
        };     
        
        function doCountUp(sendSelectGameData) { // 투표 결과 백앤드로 보낸 후 디비 업데이트
            $.ajax({
                url : "https://kusf-api-4.run.goorm.site/CountUp", 
                type : "POST", 
                data : JSON.stringify(sendSelectGameData),  
                contentType : "application/json",
                success : function(data, status, xhr) {  
                    console.log(data);
                },
                error : function(xhr, status, error) { 
                    console.log(xhr); 
                }
            });
        };


        function getVoteCount(Round) { // 업데이트 된 투표수 가져오기
            $.ajax ({
                url   : "https://kusf-api-4.run.goorm.site/Info/"+ Round,       
                type   : "GET",
                success : function(data, status, xhr) {   
                    $("#roundInfoTable").hide();
                    var voteCount = data.Updated_Vote_Count;
                    var voteRate = data.voteResult;
                    console.log(voteCount);
                    console.log(voteRate);

                    $("#voteCountTable").empty(); // 테이블 삭제
                    var columnTag = "<tr>";
                    columnTag += "<td></td>";
                    columnTag += "<td>경기</td>";
                    columnTag += "<td></td>";
                    columnTag += "<td>득표수</td>";
                    columnTag += "<td>득표비율(%)</td>";
                    columnTag += "</tr>";

                    $("#voteCountTable").append(columnTag);


                    for(var i=0; i < voteCount.length; i++) {
                        var rowHtml = "<tr>";
                        rowHtml += "<td><img src=./" + list[i].Home_Team_Logo + ".png width=20 height=20> " + list[i].Home_Team + "</td>";
                        rowHtml += "<td>" + "vs" + "</td>";
                        rowHtml += "<td>" + list[i].Away_Team + " <img src=./" + list[i].Away_Team_Logo + ".png width=20 height=20></td>";
                        rowHtml += "<td>" + voteCount[i] + "</td>";
                        rowHtml += "<td><div '><div class='progress-bar-custom'><div style='height: 100%;  border-radius: 3px; background-color: #42b983; width: " + voteRate[i] + "%" + "; transition: width 0.3s ease-in-out;'></div></div><div>" + voteRate[i] + "%" + "</div></div></td>"; //////////////////// 확인
                        rowHtml += "</tr>";
                        console.log(voteCount[i]);
                        console.log(voteRate[i]);
                        console.log(rowHtml);
                        $("#voteCountTable").append(rowHtml);
                    }
                },
                error   : function(xhr, status, error) {    
                    console.log(xhr);                      
                },
            });
        };           





        $(function() {
            getRoundPeriod();
            getRound();
        });


            
        
        
        // 조회 버튼 클릭 후 실행
        $(document).on("click", "#searchBtn", function(){ 

            Round = $("#RoundSb").val();
            // 라운드 선택 X
            if (Round === null){
                alert('라운드를 선택해주세요.');
            // 라운드 선택 O
            }else{
                $("#initialScreen").hide(); // 캘린더, 라운드별 기간 숨기기
                $("#searchWrapper").hide(); // 라운드, 조회버튼 숨기기
                alert(Round + '를 선택하셨습니다.');
                roundNumber = Round.substring(1); // "R" 제외한 숫자 부분 추출
                roundLabel = roundNumber + "라운드"; // "{숫자}라운드" 생성
                $("#roundInfoTable").show(); // 경기 일정과 투표버튼 출력
                $("#roundLabel").text(roundLabel); // 새로운 roundLabel 추가
                $("#roundInfoTable").prepend("<h3>" + roundLabel + "</h3>");

                console.log(Round);
                console.log(roundLabel);
                getRoundInfo(Round); // 몇라운드 선택되었는지 보내기 -> 선택된 라운드 정보 가져오기
            }       
        });


        // 뒤로가기 버튼 클릭 후 실행
        $(document).on("click", "#backBtn", function(){
            $("#roundInfoTable").hide(); // 라운드 정보 숨기기
            $("#roundInfoTable").children().first().remove(); // "{숫자}라운드" 삭제
            $("#initialScreen").show(); 
            $("#searchWrapper").show(); // 첫화면 그대로 보여주기
        });   
        
        
        $(document).on("click", "#voteBtn", function(){
            const voteNodeList = document.getElementsByName('vote');
            var voteVal = "";
            voteNodeList.forEach((node) => {
            if (node.checked) {
                voteVal = node.value;
            }
            }); // 선택된 radio의 value를 voteVal에 저장 

            // 경기 선택 O
            if (voteVal !== "") {
                console.log(voteVal);
                alert(voteVal + '경기에 투표되었습니다.');

                // 선택된 경기 백앤드로 보내기
                var sendSelectGameData = {
                Round_num : String(Round),
                selected_game : Number(voteVal)
                };
                console.log(sendSelectGameData)
                doCountUp(sendSelectGameData);

                // 딜레이 넣기 -> 데이터베이스 업데이트 시간 필요
                setTimeout(function() {
                    getVoteCount(Round);
                    $("#voteResultTable").show(); // 투표 결과 출력
                    $("#voteResultTable").prepend("<h3>" + roundLabel + " 투표 결과 </h3>");
                }, 1000);     
            // 경기 선택 X           
            } else {
                console.log("경기가 선택되지 않았습니다.");
                alert("경기를 선택해주세요.")
            };
        });


        // 홈으로 버튼 클릭 후 실행
        $(document).on("click", "#homeBtn", function(){
            $("#voteResultTable").hide();
            $("#roundInfoTable").children().first().remove();
            $("#voteResultTable").children().first().remove();
            $("#initialScreen").show();
            $("#searchWrapper").show(); // 초기 상태로 되돌리기
        });

    </script>
</head>

<body>
    <!-- 첫 화면 -->
    <div style="display: flex; width: 100%; height: 90px; border-bottom: 1px solid #2BFFCC; align-items: flex-start; flex-direction: column; ">
        <div style="display: flex; align-items: center; margin-left: 20px; margin-top: 20px;">
            <div class="favicon-wrapper">
                <img src="./logo.png" width=50 height=50 alt="Favicon" />
            </div>
            <div style="font-weight: 800; font-size: 30px;">
                <p style="margin-left: 10px; font-size: 25px; display: inline;">
                    잠실의 주인은 누구
                </p>
                <p style="margin-left: -5px; font-size: 20px; display: inline;">
                    조
                </p>
            </div>
        </div> <!-- 좌측 상단 -->

        <div class="tab-wrapper">
            <li class="tab-container__item" data-tab="tab2">
                일정
            </li>
            <li class="tab-container__item_active" data-tab="tab1">
                투표
            </li>
            <li class="tab-container__item" data-tab="tab2">
                무료중계
            </li>
            <li class="tab-container__item" data-tab="tab2">
                마이페이지
            </li>
        </div> <!-- 우측 상단 -->
    </div>

    <div id="titleWrapper">
        <h1>
            Vote For Your Match
        </h1>
        <div style="display: flex; align-items: center;" id="searchWrapper">
            <div>Round:</div>
            <select id="RoundSb"></select>
            <button type="button" id="searchBtn">조회</button> 
        </div>
    </div> <!-- 라운드 목록, 조회 버튼 -->

    <div id="initialScreen">
        <div id="calendar" class="custom-calendar">
            <br>
        </div> <!-- 캘린더 -->
        <div class="table-wrapper">
            <div class="table1-wrapper">
              <table class="table1" cellpadding="0" cellspacing="0" border="0">
                <tr>
                  <td>라운드</td>
                  <td>기간</td>
                </tr>
              </table> <!-- 스크롤시 고정 -->
            </div>
            <div class="table2-wrapper">
              <table id="periodTable" class="table2" cellpadding="0" cellspacing="0" border="0">
              </table> <!-- 스크롤되는 부분 -->
            </div>
        </div>        
    </div>   
    
    
    <!-- 두번째 화면 -->
    <div id="roundInfoTable" class="roundInfoTable" style="display: none;"> 
        <table id="infoTable" class="infoTable">
            <tr>
                <td></td>
                <td>날짜</td>
                <td>홈</td>
                <td></td>
                <td>어웨이</td>
                <td>시작시간</td>
            </tr>         
        </table>
        <br>
        <div>
            <button class="backBtn" id="backBtn">뒤로가기</button>
            <button class="searchBtn" id="voteBtn">투표</button>
        </div>
    </div>


    <!-- 세번째 화면 -->
    <div id="voteResultTable" class="voteResultTable" style="display: none;">
        <br>
        <table id="voteCountTable" class="voteCountTable">
            <tr>
                <td></td>
                <td>경기</td>
                <td></td>
                <td>득표수</td>
                <td>득표비율</td>
            </tr>
        </table>
        <br>
        <button class="homeBtn" id="homeBtn">홈으로</button>
    </div>

</body>
